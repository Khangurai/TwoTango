<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Love Map</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for gradients and Google Maps */
      .gradient-title {
        background: linear-gradient(to right, #f43f5e, #db2777);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: bold;
      }
      .gradient-button {
        background: linear-gradient(to right, #f43f5e, #db2777);
        border: none;
        color: white;
      }
      .gradient-button:hover {
        background: linear-gradient(to right, #e11d48, #be185d);
        color: white;
      }
      #map {
        height: 400px;
        width: 100%;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }
      .place-badge {
        background-color: #fce7f3;
        color: #db2777;
      }
      .expense-badge {
        background-color: #dcfce7;
        color: #15803d;
      }
      .gm-style-iw {
        padding: 8px !important;
      }
    </style>
  </head>
  <body>
    <div class="container px-4 py-5">
      <!-- Header -->
      <div class="text-center mb-5">
        <h2 class="display-5 gradient-title">Your Love Map</h2>
        <p class="text-muted">
          Save special places and see where you spent money together
        </p>
      </div>

      <!-- Statistics -->
      <div class="row g-4 mb-5">
        <div class="col-md-4">
          <div class="card border-danger-subtle">
            <div
              class="card-body pt-4 d-flex align-items-center justify-content-between"
            >
              <div>
                <p class="text-muted small">Special Places</p>
                <p class="fs-3 fw-bold text-danger" id="placeCount">0</p>
              </div>
              <i
                class="bi bi-heart text-danger-400"
                style="font-size: 2rem"
              ></i>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-danger-subtle">
            <div
              class="card-body pt-4 d-flex align-items-center justify-content-between"
            >
              <div>
                <p class="text-muted small">Geo-Tagged Expenses</p>
                <p class="fs-3 fw-bold text-success" id="geoTaggedCount">0</p>
              </div>
              <i
                class="bi bi-currency-dollar text-success-400"
                style="font-size: 2rem"
              ></i>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-danger-subtle">
            <div
              class="card-body pt-4 d-flex align-items-center justify-content-between"
            >
              <div>
                <p class="text-muted small">Total Mapped Spending</p>
                <p class="fs-3 fw-bold text-primary" id="totalSpending">
                  $0.00
                </p>
              </div>
              <i
                class="bi bi-geo-alt text-primary-400"
                style="font-size: 2rem"
              ></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Controls -->
      <div class="card mb-5 border-danger-subtle">
        <div class="card-body">
          <h5
            class="card-title d-flex align-items-center justify-content-between"
          >
            <span class="d-flex align-items-center">
              <i class="bi bi-heart text-danger me-2"></i> Interactive Map
            </span>
            <div class="d-flex align-items-center gap-3">
              <select id="dateFilter" class="form-select form-select-sm">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="this-week">This Week</option>
                <option value="last-7-days">Last 7 Days</option>
                <option value="this-month">This Month</option>
                <option value="last-30-days">Last 30 Days</option>
                <option value="this-year">This Year</option>
                <option value="custom">Custom Range</option>
              </select>

              <!-- <div class="form-check">
              <input class="form-check-input" type="checkbox" id="showPlaces" checked>
              <label class="form-check-label small" for="showPlaces">üíù Places</label>
            </div> -->
              <!-- <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="showExpenses"
                  checked
                />
                <label class="form-check-label small" for="showExpenses"
                  >üí∞ Expenses</label
                >
              </div> -->
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-funnel text-muted"></i>
                <select
                  class="form-select form-select-sm w-auto"
                  id="categoryFilter"
                >
                  <option value="all">All Categories</option>
                  <option value="First Date">First Date</option>
                  <option value="Restaurant">Restaurant</option>
                  <option value="Vacation">Vacation</option>
                  <option value="Special Moment">Special Moment</option>
                  <option value="Home">Home</option>
                  <option value="Anniversary">Anniversary</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="button">
                <button id="clearBtn" class="btn gradient-button">Clear</button>
              </div>
            </div>
          </h5>
          <p class="card-text text-muted small">
            Search for a place or click on the map to add a new place. üíù =
            Special places, üí∞ = Expenses
          </p>
          <input
            id="searchInput"
            class="form-control mb-3"
            type="text"
            placeholder="Search location..."
          />
          <div id="map"></div>
        </div>
      </div>

      <!-- Add Place Button -->
      <!-- <div class="mb-4">
      <button class="btn gradient-button" data-bs-toggle="modal" data-bs-target="#placeModal">
        <i class="bi bi-plus me-1"></i> Add Place Manually
      </button>
    </div> -->

      <!-- Place Modal -->
      <!-- <div class="modal fade" id="placeModal" tabindex="-1" aria-labelledby="placeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="placeModalLabel">Add New Place</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="placeForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">Place Name *</label>
                  <input type="text" class="form-control" id="name" placeholder="e.g., Our favorite caf√©" required>
                </div>
                <div class="col-md-6">
                  <label for="type" class="form-label">Type *</label>
                  <select class="form-select" id="type" required>
                    <option value="" disabled selected>Select type</option>
                    <option value="First Date">First Date</option>
                    <option value="Restaurant">Restaurant</option>
                    <option value="Vacation">Vacation</option>
                    <option value="Special Moment">Special Moment</option>
                    <option value="Home">Home</option>
                    <option value="Anniversary">Anniversary</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="lat" class="form-label">Latitude *</label>
                  <input type="text" class="form-control" id="lat" placeholder="16.845" required>
                </div>
                <div class="col-md-4">
                  <label for="lng" class="form-label">Longitude *</label>
                  <input type="text" class="form-control" id="lng" placeholder="96.173" required>
                </div>
                <div class="col-md-4">
                  <label for="date" class="form-label">Date</label>
                  <input type="date" class="form-control" id="date">
                </div>
                <div class="col-12">
                  <label for="notes" class="form-label">Notes</label>
                  <textarea class="form-control" id="notes" rows="3" placeholder="What makes this place special to you both..."></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x me-1"></i> Cancel
            </button>
            <button type="submit" class="btn gradient-button" id="submitPlace">
              <i class="bi bi-plus me-1"></i> Add Place
            </button>
          </div>
        </div>
      </div>
    </div> -->

      <!-- Places List -->
      <!-- <div class="mb-4">
      <h3 class="fs-4 fw-semibold mb-4" id="placesTitle">Your Special Places (0)</h3>
      <div id="placesList"></div>
    </div> -->

      <!-- Toast Container -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div
          id="toast"
          class="toast"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="toast"
              aria-label="Close"
            ></button>
          </div>
          <div class="toast-body"></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Maps JS with Places library -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8eYe7VhkEWSY5bHZQK13KYGNKZ0dIX-g&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <script>
      // Data and State
      let places = JSON.parse(localStorage.getItem("twotango-places")) || [];
      let expenses =
        JSON.parse(localStorage.getItem("twotango-expenses")) || [];
      let showPlaces = true;
      let showExpenses = true;
      let selectedCategory = "all";
      let formData = {
        name: "",
        notes: "",
        lat: "",
        lng: "",
        type: "",
        date: new Date().toISOString().split("T")[0],
      };
      let map = null;
      let markers = [];
      let searchMarker = null;

      // DOM Elements
      const placeModal = new bootstrap.Modal(
        document.getElementById("placeModal")
      );
      const placeForm = document.getElementById("placeForm");
      const placesList = document.getElementById("placesList");
      const toastEl = document.getElementById("toast");
      const toastBody = toastEl.querySelector(".toast-body");
      const toast = new bootstrap.Toast(toastEl);
      const showPlacesCheckbox = document.getElementById("showPlaces");
      const showExpensesCheckbox = document.getElementById("showExpenses");
      const categoryFilter = document.getElementById("categoryFilter");
      const searchInput = document.getElementById("searchInput");

      // Place Types
      const placeTypes = [
        "First Date",
        "Restaurant",
        "Vacation",
        "Special Moment",
        "Home",
        "Anniversary",
        "Other",
      ];

      // Initialize Form
      function resetForm() {
        formData = {
          name: "",
          notes: "",
          lat: "",
          lng: "",
          type: "",
          date: new Date().toISOString().split("T")[0],
        };
        placeForm.reset();
        document.getElementById("date").value = formData.date;
        document.getElementById("submitPlace").innerHTML =
          '<i class="bi bi-plus me-1"></i> Add Place';
        document.getElementById("placeModalLabel").textContent =
          "Add New Place";
      }

      // Show Toast
      function showToast(message, isError = false) {
        toastBody.textContent = message;
        toastEl.classList.toggle("text-bg-danger", isError);
        toastEl.classList.toggle("text-bg-success", !isError);
        toast.show();
      }

      // Initialize Map
      function initMap() {
        const defaultLocation = { lat: 16.845, lng: 96.173 };
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 10,
        });

        // Initialize Autocomplete
        const autocomplete = new google.maps.places.Autocomplete(searchInput);
        autocomplete.bindTo("bounds", map);
        searchInput.addEventListener("click", () => {
          searchInput.value = "";
        });
        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (!place.geometry) {
            showToast(
              "No details available for input: '" + place.name + "'",
              true
            );
            return;
          }
          map.setCenter(place.geometry.location);
          map.setZoom(15);
          if (searchMarker) searchMarker.setMap(null);
          searchMarker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
          });
        });

        // Map click event
        map.addListener("click", (e) => {
          formData.lat = e.latLng.lat().toFixed(6);
          formData.lng = e.latLng.lng().toFixed(6);
          document.getElementById("lat").value = formData.lat;
          document.getElementById("lng").value = formData.lng;
          placeModal.show();
          showToast("üìç Location selected! Fill in the details below.");
        });

        updateMapMarkers();
        showToast("Map loaded successfully! Search or click to add a place.");
      }

      // Update Map Markers
      function updateMapMarkers() {
        if (!map) return;

        // Clear existing markers (except search marker)
        markers.forEach((marker) => marker.setMap(null));
        markers = [];

        const bounds = new google.maps.LatLngBounds();
        let hasMarkers = false;

        // Add place markers
        if (showPlaces) {
          places.forEach((place) => {
            const marker = new google.maps.Marker({
              map: map,
              position: { lat: place.lat, lng: place.lng },
              icon: {
                url:
                  "data:image/svg+xml;charset=UTF-8," +
                  encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"><text x="50%" y="50%" font-size="24" text-anchor="middle" dominant-baseline="middle">üíù</text></svg>'
                  ),
                anchor: new google.maps.Point(15, 15),
              },
            });
            const infoWindow = new google.maps.InfoWindow({
              content: `
              <div class="p-2">
                <h3 class="fw-semibold text-danger">${place.name}</h3>
                <p class="small text-pink-600">${place.type}</p>
                <p class="small mt-1">${place.notes}</p>
                <p class="small text-muted mt-1">${new Date(
                  place.date
                ).toLocaleDateString()}</p>
              </div>
            `,
            });
            marker.addListener("click", () => {
              infoWindow.open(map, marker);
            });
            markers.push(marker);
            bounds.extend(new google.maps.LatLng(place.lat, place.lng));
            hasMarkers = true;
          });
        }

        // Add expense markers
        if (showExpenses) {
          const filteredExpenses = expenses.filter((exp) => {
            if (!exp.location) return false;
            if (selectedCategory !== "all" && exp.category !== selectedCategory)
              return false;
            return true;
          });
          filteredExpenses.forEach((exp) => {
            const marker = new google.maps.Marker({
              map: map,
              position: { lat: exp.location.lat, lng: exp.location.lng },
              icon: {
                url:
                  "data:image/svg+xml;charset=UTF-8," +
                  encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"><text x="50%" y="50%" font-size="20" text-anchor="middle" dominant-baseline="middle">üí∞</text></svg>'
                  ),
                anchor: new google.maps.Point(12, 12),
              },
            });
            const infoWindow = new google.maps.InfoWindow({
              content: `
              <div class="p-2">
                <h3 class="fw-semibold text-success">${exp.description}</h3>
                <p class="small text-primary">$${exp.amount.toFixed(2)}</p>
                <p class="small text-purple-600">${exp.category}</p>
                <p class="small text-muted mt-1">Paid by: ${exp.paidBy}</p>
                <p class="small text-muted">${new Date(
                  exp.date
                ).toLocaleDateString()}</p>
                ${exp.notes ? `<p class="small mt-1">${exp.notes}</p>` : ""}
              </div>
            `,
            });
            marker.addListener("click", () => {
              infoWindow.open(map, marker);
            });
            markers.push(marker);
            bounds.extend(
              new google.maps.LatLng(exp.location.lat, exp.location.lng)
            );
            hasMarkers = true;
          });
        }

        // Fit map to bounds
        if (hasMarkers && !bounds.isEmpty()) {
          map.fitBounds(bounds, { padding: 20 });
        }
      }

      // Form Submission
      placeForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (
          !formData.name ||
          !formData.lat ||
          !formData.lng ||
          !formData.type
        ) {
          showToast("Please fill in all required fields", true);
          return;
        }
        const newPlace = {
          id: Date.now().toString(),
          name: formData.name,
          notes: formData.notes,
          lat: parseFloat(formData.lat),
          lng: parseFloat(formData.lng),
          type: formData.type,
          date: formData.date,
        };
        places.unshift(newPlace);
        localStorage.setItem("twotango-places", JSON.stringify(places));
        resetForm();
        placeModal.hide();
        showToast("Place added to your love map! üíï");
        updateUI();
      });

      // Delete Place
      function deletePlace(id) {
        places = places.filter((place) => place.id !== id);
        localStorage.setItem("twotango-places", JSON.stringify(places));
        showToast("Place removed from map");
        updateUI();
      }

      // Update UI
      function updateUI() {
        // Update statistics
        const expensesWithLocation = expenses.filter((exp) => exp.location);
        document.getElementById("placeCount").textContent = places.length;
        document.getElementById("geoTaggedCount").textContent =
          expensesWithLocation.length;
        document.getElementById(
          "totalSpending"
        ).textContent = `$${expensesWithLocation
          .reduce((sum, exp) => sum + exp.amount, 0)
          .toFixed(2)}`;

        // Update category filter
        const expenseCategories = [
          ...new Set(expensesWithLocation.map((exp) => exp.category)),
        ];
        categoryFilter.innerHTML =
          `<option value="all">All Categories</option>` +
          expenseCategories
            .map((cat) => `<option value="${cat}">${cat}</option>`)
            .join("");

        // Update places list
        const expensePlaces = expensesWithLocation.map((exp) => ({
          id: `expense-${exp.id}`,
          name: exp.description,
          notes: `${exp.category} - $${exp.amount.toFixed(2)} (Paid by ${
            exp.paidBy
          })`,
          lat: exp.location.lat,
          lng: exp.location.lng,
          date: exp.date,
          type: "Expense Location",
        }));
        const allPlaces = [...places, ...expensePlaces];
        document.getElementById(
          "placesTitle"
        ).textContent = `Your Special Places (${allPlaces.length})`;
        if (allPlaces.length === 0) {
          placesList.innerHTML = `
          <div class="card border-danger-subtle">
            <div class="card-body text-center py-5">
              <div class="display-3 mb-3">üó∫Ô∏è</div>
              <h3 class="fs-4 fw-semibold mb-2">No places saved yet</h3>
              <p class="text-muted">Start building your love map by adding special places!</p>
            </div>
          </div>
        `;
        } else {
          placesList.innerHTML = `
          <div class="row g-4">
            ${allPlaces
              .map(
                (place) => `
              <div class="col-md-6">
                <div class="card border-danger-subtle">
                  <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                      <div>
                        <div class="d-flex align-items-center gap-2 mb-2">
                          <h3 class="fs-5 fw-semibold">${place.name}</h3>
                          <span class="badge ${
                            place.type === "Expense Location"
                              ? "expense-badge"
                              : "place-badge"
                          }">
                            ${
                              place.type === "Expense Location"
                                ? "üí∞ Expense"
                                : place.type
                            }
                          </span>
                        </div>
                        <p class="text-muted small mb-2">${place.notes}</p>
                        <div class="text-muted small">
                          <p><i class="bi bi-geo-alt"></i> ${place.lat.toFixed(
                            4
                          )}, ${place.lng.toFixed(4)}</p>
                          <p><i class="bi bi-calendar"></i> ${new Date(
                            place.date
                          ).toLocaleDateString()}</p>
                        </div>
                      </div>
                      ${
                        !place.id.startsWith("expense-")
                          ? `
                        <button class="btn btn-outline-danger btn-sm" onclick="deletePlace('${place.id}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      `
                          : ""
                      }
                    </div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
        }
        updateMapMarkers();
      }

      // Form Input Updates
      document
        .querySelectorAll(
          "#placeForm input, #placeForm select, #placeForm textarea"
        )
        .forEach((input) => {
          input.addEventListener("change", (e) => {
            const { id, value } = e.target;
            formData[id] = value;
          });
        });

      // Toggle Show Places/Expenses
      showPlacesCheckbox.addEventListener("change", (e) => {
        showPlaces = e.target.checked;
        updateMapMarkers();
      });
      showExpensesCheckbox.addEventListener("change", (e) => {
        showExpenses = e.target.checked;
        updateMapMarkers();
      });

      // Category Filter
      categoryFilter.addEventListener("change", (e) => {
        selectedCategory = e.target.value;
        updateMapMarkers();
      });

      // Initialize UI
      updateUI();

      // Expose deletePlace to global scope
      window.deletePlace = deletePlace;
    </script>
  </body>
</html>
